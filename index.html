<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンライン原稿用紙 Pro</title>
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700&family=Zen+Old+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-material-ui/material-ui.min.css" rel="stylesheet">

    <!-- Diff Match Patch Library (修正履歴の追跡用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>

    <?!= include('css'); ?>
</head>
<body class="d-flex flex-column">

    <!-- ヘッダー -->
    <nav class="navbar sticky-top bg-white border-bottom shadow-sm">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="#" onclick="location.reload()">
                <div class="icon-wrapper bg-primary text-white rounded-circle p-2 d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                    <i class="bi bi-pencil-square fs-5"></i>
                </div>
                <div class="lh-1">
                    <span class="fw-bold text-primary">オンライン<ruby>原稿<rt>げんこう</rt></ruby><ruby>用紙<rt>ようし</rt></ruby></span>
                    <span class="badge bg-primary ms-1 rounded-pill">Pro</span>
                </div>
            </a>
            <div class="d-flex align-items-center gap-2">
                <span id="user-info-display" class="small text-muted fw-bold me-2"></span>
                
                <!-- 設定ボタン -->
                <button class="btn btn-sm btn-outline-secondary rounded-circle p-2" id="btn-settings" title="用紙設定">
                    <i class="bi bi-gear-fill"></i>
                </button>

                <button class="btn btn-sm btn-outline-danger rounded-pill px-3 ms-2" id="btn-teacher-login">
                    <i class="bi bi-person-badge-fill me-1"></i> <ruby>先生<rt>せんせい</rt></ruby><ruby>用<rt>よう</rt></ruby>
                </button>
            </div>
        </div>
    </nav>

    <!-- メインコンテナ -->
    <div class="container-fluid main-container flex-grow-1">
        
        <!-- 【A】児童用ビュー (デフォルト) -->
        <div id="editor-view" class="row h-100 g-4">
            <!-- 左: 入力パネル -->
            <div class="col-lg-4 col-md-5 h-100" id="left-panel">
                <div class="card shadow-sm h-100 border-0">
                    <div class="card-body d-flex flex-column p-4">
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="small text-primary fw-bold"><i class="bi bi-info-circle me-1"></i><ruby>基本<rt>きほん</rt></ruby><ruby>情報<rt>じょうほう</rt></ruby></label>
                                <span id="doc-status-display" class="badge bg-secondary rounded-pill px-3"><ruby>下書<rt>したが</rt></ruby>き</span>
                            </div>
                            <div class="form-floating mb-2">
                                <input type="text" id="title" class="form-control fw-bold" placeholder="題名">
                                <label for="title"><ruby>題名<rt>だいめい</rt></ruby></label>
                            </div>
                            <div class="row g-2">
                                <div class="col-4">
                                    <div class="form-floating">
                                        <input type="text" id="class" class="form-control" placeholder="学年">
                                        <label for="class"><ruby>学年<rt>がくねん</rt></ruby></label>
                                    </div>
                                </div>
                                <div class="col-8">
                                    <div class="form-floating">
                                        <input type="text" id="name" class="form-control" placeholder="氏名">
                                        <label for="name"><ruby>氏名<rt>しめい</rt></ruby></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="input-area-wrapper flex-grow-1 mb-4 position-relative border rounded-3 overflow-hidden">
                            <textarea id="content" class="form-control border-0 h-100 p-3" placeholder="ここに作文を書いてください..."></textarea>
                        </div>

                        <!-- 生徒用ボタン -->
                        <div id="student-controls" class="d-grid gap-2">
                            <div class="row g-2">
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary w-100 py-2 rounded-3" id="btn-new">
                                        <i class="bi bi-plus-lg me-1"></i> <ruby>新規<rt>しんき</rt></ruby>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-primary w-100 py-2 rounded-3" id="btn-load">
                                        <i class="bi bi-folder2-open me-1"></i> <ruby>読<rt>よ</rt></ruby>み<ruby>込<rt>こ</rt></ruby>み
                                    </button>
                                </div>
                            </div>
                            <div class="row g-2">
                                <div class="col-6">
                                    <button class="btn btn-primary w-100 py-2 rounded-3 fw-bold shadow-sm" id="btn-save">
                                        <i class="bi bi-save me-1"></i> <ruby>保存<rt>ほぞん</rt></ruby>
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-danger w-100 py-2 rounded-3 fw-bold shadow-sm" id="btn-submit">
                                        <i class="bi bi-send-fill me-1"></i> <ruby>提出<rt>ていしゅつ</rt></ruby>
                                    </button>
                                </div>
                            </div>
                            <button class="btn btn-success w-100 py-2 rounded-3 mt-1" id="btn-print">
                                <i class="bi bi-printer me-1"></i> <ruby>印刷<rt>いんさつ</rt></ruby>する
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右: プレビュー -->
            <div class="col-lg-8 col-md-7 h-100">
                <div class="card preview-area shadow-sm border-0 h-100" id="paper-container">
                    <div id="paper-wrapper">
                        <div id="paper-scaler">
                            <div class="paper-sheet" id="paper-sheet"><div id="genko-grid" class="genko-grid-wrapper"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 【B】教師用ダッシュボード -->
        <div id="teacher-dashboard" class="h-100 d-none">
            <div class="row h-100 g-0 shadow-sm rounded-3 overflow-hidden bg-white border">
                
                <!-- 左ペイン: リスト -->
                <div class="col-md-3 h-100 border-end d-flex flex-column bg-light">
                    <div class="p-3 border-bottom bg-white">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="m-0 text-danger fw-bold"><i class="bi bi-speedometer2 me-1"></i> <ruby>管理<rt>かんり</rt></ruby><ruby>画面<rt>がめん</rt></ruby></h6>
                            <button class="btn btn-sm btn-outline-secondary" id="btn-teacher-logout">ログアウト</button>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <div class="form-check m-0" title="全て選択">
                                <input class="form-check-input" type="checkbox" id="check-all">
                            </div>
                            <button class="btn btn-sm btn-outline-primary flex-grow-1" id="btn-refresh-list">
                                <i class="bi bi-arrow-clockwise me-1"></i> <ruby>更新<rt>こうしん</rt></ruby>
                            </button>
                            <button class="btn btn-sm btn-outline-success" id="btn-bulk-print" title="チェックしたものを一括印刷">
                                <i class="bi bi-printer"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex-grow-1 overflow-auto" id="teacher-list-container">
                        <div class="list-group list-group-flush" id="teacher-dashboard-list">
                            <!-- JSでリスト生成 -->
                        </div>
                    </div>
                </div>

                <!-- 右ペイン: プレビュー & 評価 -->
                <div class="col-md-9 h-100 d-flex flex-column">
                    <!-- ツールバー -->
                    <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center" style="z-index: 10;">
                        <div id="preview-info" class="fw-bold px-2 text-muted small">
                            リストから<ruby>選択<rt>せんたく</rt></ruby>してください
                        </div>
                        <div class="d-flex gap-2" id="teacher-action-buttons">
                            <button class="btn btn-sm btn-outline-danger disabled rounded-pill px-3" id="btn-action-rework">
                                <ruby>再<rt>さい</rt></ruby><ruby>提出<rt>ていしゅつ</rt></ruby>
                            </button>
                            <button class="btn btn-sm btn-success fw-bold disabled rounded-pill px-3" id="btn-action-complete">
                                <ruby>完了<rt>かんりょう</rt></ruby>(<ruby>合格<rt>ごうかく</rt></ruby>)にして<ruby>次<rt>つぎ</rt></ruby>へ &gt;
                            </button>
                        </div>
                    </div>

                    <!-- プレビュー領域 -->
                    <div class="flex-grow-1 preview-area position-relative bg-light" id="teacher-preview-container">
                        <div id="teacher-paper-wrapper">
                            <div id="teacher-paper-scaler">
                                <div class="paper-sheet">
                                    <div id="teacher-genko-grid" class="genko-grid-wrapper"></div>
                                </div>
                            </div>
                        </div>
                        <div class="position-absolute top-0 start-0 m-3 p-3 bg-white shadow rounded-3 small text-muted border">
                            <i class="bi bi-info-circle-fill text-primary me-1"></i> <ruby>文字<rt>もじ</rt></ruby>をドラッグしてコメント
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 固定フッター (GIGA Standard) -->
    <footer class="text-center text-muted py-3 mt-4 border-top bg-white">
        <small>© 2026 オンライン原稿用紙 Pro <a href="https://note.com/cute_borage86" target="_blank" class="text-decoration-none text-muted">GIGA山</a></small>
    </footer>

    <!-- ローディング -->
    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="mt-3 fw-bold text-dark fs-5"><ruby>処理<rt>しょり</rt></ruby><ruby>中<rt>ちゅう</rt></ruby>です...</div>
    </div>
    
    <!-- 印刷用レンダリングエリア -->
    <div id="print-render-area"></div>

    <!-- 添削モーダル -->
    <div class="modal fade" id="correctionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger text-white py-2">
                    <h6 class="modal-title"><ruby>添削<rt>てんさく</rt></ruby>コメント</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <textarea id="correction-text" class="form-control" rows="3" placeholder="コメントを入力..."></textarea>
                </div>
                <div class="modal-footer py-2 bg-light">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-sm btn-danger px-4" id="btn-save-correction"><ruby>決定<rt>けってい</rt></ruby></button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <?!= include('js'); ?>

</body>
</html>
